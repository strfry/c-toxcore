machine:
  timezone:
    Europe/Vienna
  environment:
    MAKEFLAGS: "j4"
dependencies:
  pre:
    - sudo apt-get update
    - sudo apt-get install clang
    - sudo sudo apt-get install build-essential libtool autotools-dev automake checkinstall check git yasm
    - sudo apt-get install libopus-dev libvpx-dev pkg-config

    #- sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang 100
    #- sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++ 100

    - gcc --version ; exit 0
    - clang --version ; exit 0

    ### ------- get libsodium -------
    - mkdir ~/libsodium
    - cd ~/libsodium/ ; git clone https://github.com/jedisct1/libsodium.git
    - cd ~/libsodium/ ; cd libsodium/ ; git checkout tags/1.0.11
    - cd ~/libsodium/ ; cd libsodium/ ; ./autogen.sh
    - cd ~/libsodium/ ; cd libsodium/ ; ./configure && make check
    - cd ~/libsodium/ ; cd libsodium/ ; sudo bash -c "printf 'y\naa\n\n' | checkinstall --install --pkgname libsodium --pkgversion 1.0.0 --nodoc --deldesc=no --pkglicense='GPL2'"
    - cd ~/libsodium/ ; cd libsodium/ ; sudo ldconfig
    ### ------- get libsodium -------

##### ------------ BUILD ------------
    - cmake -DWARNINGS=OFF .
    #- cmake .
    - make
    - sudo make install
    - sudo ldconfig -v 2>/dev/null | grep toxcore
    - sudo ldconfig -v 2>/dev/null | grep sodium
##### ------------ BUILD ------------

test:
  override:
# run tests
    - make test
# compile echobot and start it
    - cd echobot ; gcc -O2 -o echo_bot echo_bot.c -std=gnu99 -lsodium -I /usr/local/include/ -ltoxcore
    - cd echobot ; ldd echo_bot
    - cd echobot ; ./echo_bot :
        background: true
    - sleep 10
    - cd echobot ; cat ./echobot.log
    - cd echobot ; cat ./echobot.log | grep '\-\-MyToxID\-\-:' | cut -d':' -f 2
    - sleep 240

